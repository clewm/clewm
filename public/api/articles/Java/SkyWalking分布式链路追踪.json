{"title":"SkyWalking","uid":"61002d5c25b8c7e1297b605504df9169","slug":"Java/SkyWalking分布式链路追踪","date":"2022-08-19T22:55:50.542Z","updated":"2022-11-22T02:45:52.605Z","comments":true,"path":"api/articles/Java/SkyWalking分布式链路追踪.json","keywords":null,"cover":[],"content":"<h1 id=\"SkyWalking\"><a href=\"#SkyWalking\" class=\"headerlink\" title=\"SkyWalking\"></a>SkyWalking</h1><h3 id=\"下载地址：http-skywalking-apache-org-downloads\"><a href=\"#下载地址：http-skywalking-apache-org-downloads\" class=\"headerlink\" title=\"下载地址：http://skywalking.apache.org/downloads/\"></a>下载地址：<a href=\"http://skywalking.apache.org/downloads/\">http://skywalking.apache.org/downloads/</a></h3><h2 id=\"概念：\"><a href=\"#概念：\" class=\"headerlink\" title=\"概念：\"></a>概念：</h2><p>可实现基于Open Tracing规范的分布式链路追踪功能的APM应用性能管理平台</p>\n<p><img src=\"https://md-1259549904.cos.ap-shanghai.myqcloud.com/img/image-20220823114137847.png\" alt=\"image-20220823114137847\"></p>\n<h3 id=\"UI界面的jar包和配置文件（可修改端-口）\"><a href=\"#UI界面的jar包和配置文件（可修改端-口）\" class=\"headerlink\" title=\"UI界面的jar包和配置文件（可修改端  口）\"></a>UI界面的jar包和配置文件（可修改端  口）</h3><p><img src=\"https://md-1259549904.cos.ap-shanghai.myqcloud.com/img/image-20220823114222953.png\" alt=\"image-20220823114222953\"></p>\n<p>修改skywalking服务端数据存储方式：</p>\n<p>默认是使用H2进行存储，如果服务端重启的话，数据就会丢失，推荐使用es存储，可以在如下位置处进行修改：</p>\n<p><img src=\"https://md-1259549904.cos.ap-shanghai.myqcloud.com/img/image-20220823134907000.png\" alt=\"image-20220823134907000\"></p>\n<p>selector处修改为elasticsearch，然后修改es的一些默认配置即可</p>\n<p><img src=\"https://md-1259549904.cos.ap-shanghai.myqcloud.com/img/image-20220823134723074.png\" alt=\"image-20220823134723074\"></p>\n<h3 id=\"端口说明\"><a href=\"#端口说明\" class=\"headerlink\" title=\"端口说明\"></a>端口说明</h3><p><img src=\"https://md-1259549904.cos.ap-shanghai.myqcloud.com/img/image-20220823114611913.png\" alt=\"image-20220823114611913\"></p>\n<h2 id=\"服务接入\"><a href=\"#服务接入\" class=\"headerlink\" title=\"服务接入\"></a>服务接入</h2><p>比如我需要在window系统上启动一个需要被监控的服务，就需要在这个系统上提前准备一个和skywalking服务端对应版本的skywalking-agent.jar</p>\n<p>下载地址：<a href=\"https://archive.apache.org/dist/skywalking/%EF%BC%8C%E8%A7%A3%E5%8E%8B%E5%90%8E%E5%9C%A8%E6%A0%B9%E7%9B%AE%E5%BD%95%E5%8D%B3%E5%8F%AF%E6%89%BE%E5%88%B0%EF%BC%8C170%E5%A4%9AMB%E7%9A%84%E9%82%A3%E4%B8%AA\">https://archive.apache.org/dist/skywalking/，解压后在根目录即可找到，170多MB的那个</a></p>\n<ul>\n<li>如果是通过idea启动的话，在启动配置的VM参数处填入以下：</li>\n</ul>\n<pre class=\"line-numbers language-bash\" data-language=\"bash\"><code class=\"language-bash\">-javaagent:C:\\_Code\\lcss\\lcss-gateway\\agent\\skywalking-agent.jar #jar包具体位置\n-Dskywalking.agent.service_name&#x3D;lcss-gateway #服务名，最好与nacos中的名字对应\n-Dskywalking.collector.backend_service&#x3D;192.168.1.104:11800 #skywalking服务端暴露的收集数据的端口</code></pre>\n\n<ul>\n<li>如果是在docker中的话：</li>\n</ul>\n<p>同样需要提前准备agent（包含有jar包）</p>\n<p>原本项目的启动方式：</p>\n<pre class=\"line-numbers language-bash\" data-language=\"bash\"><code class=\"language-bash\">java -jar spring-boot-demo-0.0.1-SNAPSHOT.jar</code></pre>\n\n<p>现在变为：</p>\n<pre class=\"line-numbers language-bash\" data-language=\"bash\"><code class=\"language-bash\">java -javaagent:&#x2F;opt&#x2F;apache-skywalking-apm-bin&#x2F;agent&#x2F;skywalking-agent.jar -Dskywalking.agent.service_name&#x3D;服务名 -Dskywalking.collector.backend_service&#x3D;127.0.0.1:11800 -jar &#x2F;opt&#x2F;spring-boot-demo-0.0.1-SNAPSHOT.jar</code></pre>\n\n\n\n<h3 id=\"操作如下：\"><a href=\"#操作如下：\" class=\"headerlink\" title=\"操作如下：\"></a>操作如下：</h3><p>与Src目录平级下建一个agent文件夹，放agent文件夹（从如下路径拷贝来的）</p>\n<p><img src=\"https://md-1259549904.cos.ap-shanghai.myqcloud.com/img/image-20220916142200142.png\" alt=\"image-20220916142200142\"></p>\n<p><img src=\"https://md-1259549904.cos.ap-shanghai.myqcloud.com/img/image-20220916142128932.png\" alt=\"image-20220916142128932\"></p>\n<p>文件：</p>\n<pre class=\"line-numbers language-docker\" data-language=\"docker\"><code class=\"language-docker\">FROM openjdk:8-jdk-alpine\n\nRUN mkdir -p &#x2F;lcss-gateway\n\nWORKDIR &#x2F;lcss-gateway\n\nARG JAR_FILE&#x3D;target&#x2F;lcss-gateway.jar\n\nCOPY $&#123;JAR_FILE&#125; app.jar\nCOPY agent &#x2F;lcss-gateway&#x2F;agent &#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&gt;&gt;&gt;&gt;关键,把agent的jar包复制到容器中\n\nEXPOSE 20010\n\nENTRYPOINT [&quot;java&quot;, &quot;-javaagent:&#x2F;lcss-gateway&#x2F;agent&#x2F;skywalking-agent.jar&quot;, &quot;-Dskywalking.agent.service_name&#x3D;lcss-gateway&quot;,&quot;-Dskywalking.collector.backend_service&#x3D;192.168.1.104:11800&quot;, &quot;-jar&quot;,&quot;app.jar&quot;]</code></pre>\n\n<h3 id=\"ps-docker部署启动的时候提示config没找到的踩坑\"><a href=\"#ps-docker部署启动的时候提示config没找到的踩坑\" class=\"headerlink\" title=\"ps:docker部署启动的时候提示config没找到的踩坑\"></a>ps:docker部署启动的时候提示config没找到的踩坑</h3><p>项目的agent不能只拷贝一个jar包，需要把整个agent文件夹都拷贝进去，因为里面还有配置文件！！</p>\n<h2 id=\"日志收集（版本8-4及以上！）\"><a href=\"#日志收集（版本8-4及以上！）\" class=\"headerlink\" title=\"日志收集（版本8.4及以上！）\"></a>日志收集（版本8.4及以上！）</h2><p><strong>ps：SpringBoot默认的日志框架是logback，这里介绍的也是基于logback的日志收集方法，可以配合Lombok的@Slf4j正常使用</strong>****</p>\n<p>依赖：</p>\n<pre class=\"line-numbers language-markup\" data-language=\"markup\"><code class=\"language-markup\">&lt;dependency&gt;\n    &lt;groupId&gt;org.apache.skywalking&lt;&#x2F;groupId&gt;\n    &lt;artifactId&gt;apm-toolkit-trace&lt;&#x2F;artifactId&gt;\n    &lt;version&gt;8.5.0&lt;&#x2F;version&gt; &#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;该版本最好和skyWalking的版本对应\n&lt;&#x2F;dependency&gt;\n\n&lt;dependency&gt;\n    &lt;groupId&gt;org.apache.skywalking&lt;&#x2F;groupId&gt;\n    &lt;artifactId&gt;apm-toolkit-logback-1.x&lt;&#x2F;artifactId&gt;\n    &lt;version&gt;8.5.0&lt;&#x2F;version&gt; &#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;该版本最好和skyWalking的版本对应\n&lt;&#x2F;dependency&gt;</code></pre>\n\n\n\n<p>在resource下创建logback-spring.xml文件</p>\n<pre class=\"line-numbers language-markup\" data-language=\"markup\"><code class=\"language-markup\">&lt;?xml version&#x3D;&quot;1.0&quot; encoding&#x3D;&quot;UTF-8&quot;?&gt;\n&lt;configuration scan&#x3D;&quot;true&quot; scanPeriod&#x3D;&quot;10 seconds&quot;&gt;\n\n    &lt;appender name&#x3D;&quot;stdout&quot; class&#x3D;&quot;ch.qos.logback.core.ConsoleAppender&quot;&gt; &#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;用来格式化日志输出的\n        &lt;encoder class&#x3D;&quot;ch.qos.logback.core.encoder.LayoutWrappingEncoder&quot;&gt;\n            &lt;layout class&#x3D;&quot;org.apache.skywalking.apm.toolkit.log.logback.v1.x.TraceIdPatternLogbackLayout&quot;&gt;\n                &lt;Pattern&gt;%d&#123;yyyy-MM-dd HH:mm:ss.SSS&#125; [%tid] [%thread] %-5level %logger&#123;36&#125; -%msg%n&lt;&#x2F;Pattern&gt;\n            &lt;&#x2F;layout&gt;\n        &lt;&#x2F;encoder&gt;\n    &lt;&#x2F;appender&gt;\n\n    &lt;appender name&#x3D;&quot;grpc&quot; &#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;用来上报日志的class&#x3D;&quot;org.apache.skywalking.apm.toolkit.log.logback.v1.x.log.GRPCLogClientAppender&quot;&gt;\n        &lt;encoder class&#x3D;&quot;ch.qos.logback.core.encoder.LayoutWrappingEncoder&quot;&gt;\n            &lt;layout class&#x3D;&quot;org.apache.skywalking.apm.toolkit.log.logback.v1.x.mdc.TraceIdMDCPatternLogbackLayout&quot;&gt;\n                &lt;Pattern&gt;%d&#123;yyyy-MM-dd HH:mm:ss.SSS&#125; [%X&#123;tid&#125;] [%thread] %-5level %logger&#123;36&#125; -%msg%n&lt;&#x2F;Pattern&gt;\n            &lt;&#x2F;layout&gt;\n        &lt;&#x2F;encoder&gt;\n    &lt;&#x2F;appender&gt;\n\n    &lt;root level&#x3D;&quot;INFO&quot;&gt;\n        &lt;appender-ref ref&#x3D;&quot;stdout&quot;&#x2F;&gt; &#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;用来格式化日志输出的\n        &lt;appender-ref ref&#x3D;&quot;grpc&quot;&#x2F;&gt; &#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;用来上报日志的\n    &lt;&#x2F;root&gt;\n&lt;&#x2F;configuration&gt;</code></pre>\n\n<p>如果服务和skyWalking不在同一个服务器上，还需要在agent文件夹下的config的agent.config中添加如下配置：</p>\n<pre class=\"line-numbers language-none\"><code class=\"language-none\">plugin.toolkit.log.grpc.reporter.server_host&#x3D;$&#123;SW_GRPC_LOG_SERVER_HOST:172.28.231.100&#125;  &#x3D;&#x3D;&#x3D;地址\nplugin.toolkit.log.grpc.reporter.server_port&#x3D;$&#123;SW_GRPC_LOG_SERVER_PORT:11800&#125; &#x3D;&#x3D;&#x3D;端口\nplugin.toolkit.log.grpc.reporter.max_message_size&#x3D;$&#123;SW_GRPC_LOG_MAX_MESSAGE_SIZE:10485760&#125; &#x3D;&#x3D;&#x3D;最大日志大小\nplugin.toolkit.log.grpc.reporter.upstream_timeout&#x3D;$&#123;SW_GRPC_LOG_GRPC_UPSTREAM_TIMEOUT:30&#125; </code></pre>\n\n<p>如何定位某条日志对应的调用链路？</p>\n<p><img src=\"https://md-1259549904.cos.ap-shanghai.myqcloud.com/img/image-20220918111842645.png\" alt=\"image-20220918111842645\"></p>\n<p>通过该TID在skyWalking中进行搜索，不支持模糊查询</p>\n<p><img src=\"https://md-1259549904.cos.ap-shanghai.myqcloud.com/img/image-20220918111916766.png\" alt=\"image-20220918111916766\"></p>\n","text":"SkyWalking下载地址：http://skywalking.apache.org/downloads/概念：可实现基于Open Tracing规范的分布式链路追踪功能的APM应用性能管理平台 UI界面的jar包和配置文件（可修改端 口） 修改skywalking服务端数据存...","link":"","photos":[],"count_time":{"symbolsCount":"5.4k","symbolsTime":"5 mins."},"categories":[{"name":"技术","slug":"技术","count":6,"path":"api/categories/技术.json"},{"name":"分布式","slug":"技术/分布式","count":4,"path":"api/categories/技术/分布式.json"},{"name":"中间件","slug":"技术/分布式/中间件","count":2,"path":"api/categories/技术/分布式/中间件.json"},{"name":"分布式链路追踪","slug":"技术/分布式/中间件/分布式链路追踪","count":1,"path":"api/categories/技术/分布式/中间件/分布式链路追踪.json"}],"tags":[{"name":"Java","slug":"Java","count":6,"path":"api/tags/Java.json"},{"name":"分布式","slug":"分布式","count":3,"path":"api/tags/分布式.json"}],"toc":"<ol class=\"toc\"><li class=\"toc-item toc-level-1\"><a class=\"toc-link\" href=\"#SkyWalking\"><span class=\"toc-text\">SkyWalking</span></a><ol class=\"toc-child\"><li class=\"toc-item toc-level-3\"><a class=\"toc-link\" href=\"#%E4%B8%8B%E8%BD%BD%E5%9C%B0%E5%9D%80%EF%BC%9Ahttp-skywalking-apache-org-downloads\"><span class=\"toc-text\">下载地址：http:&#x2F;&#x2F;skywalking.apache.org&#x2F;downloads&#x2F;</span></a></li></ol></li><li class=\"toc-item toc-level-2\"><a class=\"toc-link\" href=\"#%E6%A6%82%E5%BF%B5%EF%BC%9A\"><span class=\"toc-text\">概念：</span></a><ol class=\"toc-child\"><li class=\"toc-item toc-level-3\"><a class=\"toc-link\" href=\"#UI%E7%95%8C%E9%9D%A2%E7%9A%84jar%E5%8C%85%E5%92%8C%E9%85%8D%E7%BD%AE%E6%96%87%E4%BB%B6%EF%BC%88%E5%8F%AF%E4%BF%AE%E6%94%B9%E7%AB%AF-%E5%8F%A3%EF%BC%89\"><span class=\"toc-text\">UI界面的jar包和配置文件（可修改端  口）</span></a></li><li class=\"toc-item toc-level-3\"><a class=\"toc-link\" href=\"#%E7%AB%AF%E5%8F%A3%E8%AF%B4%E6%98%8E\"><span class=\"toc-text\">端口说明</span></a></li></ol></li><li class=\"toc-item toc-level-2\"><a class=\"toc-link\" href=\"#%E6%9C%8D%E5%8A%A1%E6%8E%A5%E5%85%A5\"><span class=\"toc-text\">服务接入</span></a><ol class=\"toc-child\"><li class=\"toc-item toc-level-3\"><a class=\"toc-link\" href=\"#%E6%93%8D%E4%BD%9C%E5%A6%82%E4%B8%8B%EF%BC%9A\"><span class=\"toc-text\">操作如下：</span></a></li><li class=\"toc-item toc-level-3\"><a class=\"toc-link\" href=\"#ps-docker%E9%83%A8%E7%BD%B2%E5%90%AF%E5%8A%A8%E7%9A%84%E6%97%B6%E5%80%99%E6%8F%90%E7%A4%BAconfig%E6%B2%A1%E6%89%BE%E5%88%B0%E7%9A%84%E8%B8%A9%E5%9D%91\"><span class=\"toc-text\">ps:docker部署启动的时候提示config没找到的踩坑</span></a></li></ol></li><li class=\"toc-item toc-level-2\"><a class=\"toc-link\" href=\"#%E6%97%A5%E5%BF%97%E6%94%B6%E9%9B%86%EF%BC%88%E7%89%88%E6%9C%AC8-4%E5%8F%8A%E4%BB%A5%E4%B8%8A%EF%BC%81%EF%BC%89\"><span class=\"toc-text\">日志收集（版本8.4及以上！）</span></a></li></ol></li></ol>","author":{"name":"CleWm","slug":"blog-author","avatar":"https://md-1259549904.cos.ap-shanghai.myqcloud.com/img/467a8fb87ff3c96961397cd53bcc2c0.jpg","link":"/","description":"记录学习 & 生活的碎片，欢迎参观！","socials":{"github":"","twitter":"","stackoverflow":"","wechat":"","qq":"","weibo":"","zhihu":"","csdn":"","juejin":"","customs":{}}},"mapped":true,"prev_post":{"title":"可复用代码","uid":"a790fe72b285743baec96ab6632ed42e","slug":"Java/可复用代码","date":"2022-11-02T01:20:37.454Z","updated":"2022-11-03T23:41:52.931Z","comments":true,"path":"api/articles/Java/可复用代码.json","keywords":null,"cover":"https://md-1259549904.cos.ap-shanghai.myqcloud.com/img/%E5%8F%A4%E9%A3%8E%20%E5%B1%85%E5%A3%AB%20%E9%BB%91%E7%99%BD%20%E7%BE%8E%E5%A5%B3%20%E5%A3%81%E7%BA%B8%204k_%E5%BD%BC%E5%B2%B8%E5%9B%BE%E7%BD%91.jpg","text":"记录了一些可复用的代码，避免重复编写浪费精力。 可复用代码结果类：package com.clewm.lcss.res; import lombok.AllArgsConstructor; import lombok.Data; import lombok.NoArgsConst...","link":"","photos":[],"count_time":{"symbolsCount":"9.8k","symbolsTime":"9 mins."},"categories":[{"name":"技术","slug":"技术","count":6,"path":"api/categories/技术.json"},{"name":"开发常用","slug":"技术/开发常用","count":1,"path":"api/categories/技术/开发常用.json"}],"tags":[{"name":"Java","slug":"Java","count":6,"path":"api/tags/Java.json"}],"author":{"name":"CleWm","slug":"blog-author","avatar":"https://md-1259549904.cos.ap-shanghai.myqcloud.com/img/467a8fb87ff3c96961397cd53bcc2c0.jpg","link":"/","description":"记录学习 & 生活的碎片，欢迎参观！","socials":{"github":"","twitter":"","stackoverflow":"","wechat":"","qq":"","weibo":"","zhihu":"","csdn":"","juejin":"","customs":{}}}},"next_post":{"title":"分布式ID","uid":"cebe9414641c5085bfbfba73b0875917","slug":"Java/分布式ID","date":"2022-07-20T01:57:56.986Z","updated":"2022-11-03T23:44:08.464Z","comments":true,"path":"api/articles/Java/分布式ID.json","keywords":null,"cover":"https://md-1259549904.cos.ap-shanghai.myqcloud.com/img/4k%20%E7%BE%8E%E5%A5%B3%20%E7%99%BD%E8%89%B2%E5%8F%A4%E8%A3%85%20%E5%8F%A4%E9%A3%8E%20%D0%A1%CF%AA%20%E7%80%91%E5%B8%83%20%E5%B2%A9%E7%9F%B3%20%E9%AB%98%E6%B8%85%20%E5%A3%81%E7%BA%B8_%E5%BD%BC%E5%B2%B8%E5%9B%BE%E7%BD%91.jpg","text":" 分布式ID雪花算法 共64位，这三个部分是保证唯一性的重要条件，缺一不可，但是可以根据业务需要调整他们占用的位数，添加其他的信息，比如业务代码。 工作流程 还需要配合Redis一起使用 雪花算法生成ID配合Redis使用实现集群唯一ID(长度为18位)&#x2F;** * @a...","link":"","photos":[],"count_time":{"symbolsCount":"3.1k","symbolsTime":"3 mins."},"categories":[{"name":"技术","slug":"技术","count":6,"path":"api/categories/技术.json"},{"name":"分布式","slug":"技术/分布式","count":4,"path":"api/categories/技术/分布式.json"}],"tags":[{"name":"Java","slug":"Java","count":6,"path":"api/tags/Java.json"},{"name":"分布式","slug":"分布式","count":3,"path":"api/tags/分布式.json"}],"author":{"name":"CleWm","slug":"blog-author","avatar":"https://md-1259549904.cos.ap-shanghai.myqcloud.com/img/467a8fb87ff3c96961397cd53bcc2c0.jpg","link":"/","description":"记录学习 & 生活的碎片，欢迎参观！","socials":{"github":"","twitter":"","stackoverflow":"","wechat":"","qq":"","weibo":"","zhihu":"","csdn":"","juejin":"","customs":{}}}}}